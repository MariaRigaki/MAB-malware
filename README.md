
# Adversarial Malware
This project is the implementation of the paper "Automatic Generation of Adversarial Examples for Interpreting Malware Classifiers".

## Installation
1. Install the following packages.
    It is recommended to use a virtual environment for Python.
    ```sh
    $ sudo apt install python3-venv
    $ python3 -m venv venv_AM
    $ source venv_AM/bin/activate
    $ pip install wheel numpy pefile matplotlib scipy pexpect
    $ sudo apt install cifs-utils python-tk virtualbox
    ```
2. Preparation for the guest machine.
    - Create a virtual machine in VirtualBox.
    - Install the antivirus software you want to evaluate, and update its virus definition.
    - In VirtualBox, Click *File -> Host Network Manager*, create a network *"vboxnet0"* if not exists.
    - Select your virtual machine, press *Ctrl + S* to start the *"Settings"* window. Select *"Network"*, change *"Attached to"* to *"Host-only Adapter"*.
    - Create a shared folder:
        - Create a folder named *"share"* on the Desktop folder of the guest machine:
        - Right-click the folder and click *"Properties"*.
        - Open the *"sharing"* tab and click *"Advanced Sharing"*.
        - Check the *"share this folder"* box and click on *"Permissions"*.
        - Choose *"everyone"* to give full control.
        - Open the *"Security"* tab and click Edit. Select *"Everyone"* in the *"Group or user names"* to give full control. If *"Everyone"* does not exist, click on *"Add"* to create one.
    - Set a static IP address for the guest machine. For example, 192.168.56.56.
    - Update the following paths in *conf/configure.ini*:
        - *vm_username*: the username of the virtual machine OS.
        - *vm_ip*: the static IP address of the virtual machine.
3. Install Cuckoo Sandbox. More details can be found [here](https://cuckoo.sh/docs/installation/index.html).

## Data preparation
1. Malware dataset.
    - If you want to use your malware dataset, change the *"malware_folder"* in *conf/configure.ini*.
    - If you want to reproduce the result in our paper, you can download malware samples in the *data/malware_sha256.txt* file, and put them in the *data/malware/* folder. Every malware is verified to having malicious behaviors in Cuckoo Sandbox with Windows 7 guest OS.
2. Benignware dataset.
    - If you want to use your benign dataset, change the *"benignware_folder"* in *conf/configure.ini*.
    - If you want to reproduce the result in our paper, you can search and copy all *".exe"* and *".dll"* files in a Microsoft Windows system, and put them in the *data/benignware/* folder:
    - Then run the following command:
    ```sh
    $ python get_benign_section_name_content.py
    ```

## How to run it?
1. Conduct code randomization for all samples in your dataset. Since CR action is very time consuming, we generate code randomized samples in an off-line fashion.
    - If you want to exclude the CR action, you can skip this step.
    - Otherwise, please set up the environment by following the *README* of the **ORP** project [here](https://github.com/bitsecurerlab/adversarial_malware/blob/master/orp-0.3/README). A modified version can be found in our project, in which we fix several implement errors.
    - Run the following commands to dump the CFG and randomize a sample:
    ```cmd
    > python orp.py -d path/to/exe
    > python orp.py -r path/to/exe
    ```
    - Copy randomized malware samples (with .CR extension) to the folder *data/randomized/*.
    - For more information, please refer to their [paper](https://ieeexplore.ieee.org/stamp/stamp.jsp?arnumber=6234439).
2. Start the **Binary Rewriter**.
    ```sh
    $ python rewriter.py [av_name]
    ```
    Input your host OS password and the guest OS password to provide the privilege to create a shared folder between them.
3. While the Binary Rewriter is running, open another terminal and start the **Action Sequence Minimizer**.
    ```sh
    $ python minimizer.py [av_name]
    ```
4. After Rewriter and Minimizer finish, use the **Verifier** to evaluate the functionality of evasive samples.
    - Start Cuckoo, web interface and API server. Please refer to the document of Cuckoo sandbox [[1](https://cuckoo.readthedocs.io/en/latest/usage/start/) [2](https://cuckoo.readthedocs.io/en/latest/usage/web/) [3](https://cuckoo.readthedocs.io/en/latest/usage/api/)].
    - Update *"token"* in *conf/configure.ini* with the value of *"api_token"* in */home/[username]/.cuckoo/conf/cuckoo.conf*.
    - Clean up previous tasks if any:
    ```sh
    $ cuckoo clean
    ```
    - Submit all evasive samples in the folder *output/[av_name]_minimized/* and the corresponding original samples to Cuckoo for analysis.
    - Run the following scripts:
    ```sh
    $ python verifier.py [av_name]
    ```
5. Start the **Feature Interpreter**.
    ```sh
    $ python interpreter.py [av_name]
    ```
